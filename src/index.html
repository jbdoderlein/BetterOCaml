<!DOCTYPE html>
<html lang="en">
<head>
    <title>BetterOCaml</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="57x57" href="icon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="icon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="icon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="icon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="icon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="icon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="icon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="icon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#263238">
    <meta name="msapplication-TileImage" content="icon/ms-icon-144x144.png">
    <meta name="theme-color" content="#263238">
    <link href="css/icon.css" rel="stylesheet">
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" id="css_theme" href="css/theme/material.css">
    <link rel="stylesheet" href="css/materialize/materialize.min.css">
    <link rel="stylesheet" href="css/codemirror/codemirror.min.css">
    <link rel="stylesheet" href="css/codemirror/dialog.css"/>
    <link rel="stylesheet" href="css/codemirror/show-hint.css"/>
    <script src="js/codemirror/codemirror.min.js"></script>
    <script src="js/codemirror/matchbrackets.min.js"></script>
    <script src="js/codemirror/closebrackets.js"></script>
    <script src="js/codemirror/mllike.min.js"></script>
    <script src="js/codemirror/dialog.js"></script>
    <script src="js/codemirror/searchcursor.js"></script>
    <script src="js/codemirror/search.js"></script>
    <script src="js/codemirror/jump-to-line.js"></script>
    <script src="js/codemirror/show-hint.js"></script>
    <script async src="js/resizer.js"></script>
    <script async defer src="js/buttons.js"></script>
    <script async src="js/toplevel-4.11.1.js"></script>
</head>

<div id="loader-wrapper">
    <div id="loader" class="container">
        <img src="icon/banner.png">
        <h2 class="center white-text">Loading Ocaml Interpreter</h2>
        <p class="center white-text">BetterOcaml will be ready in few seconds ...</p>
        <div class="progress">
            <div class="indeterminate"></div>
        </div>
    </div>
</div>

<body>

<nav class="nav-extended">
    <div class="nav-wrapper">
        <a class="brand-logo hide-on-small-and-down">BetterOCaml</a>
        <ul class="right">
            <li>
                <a onclick="editors[Math.max(...Object.keys(editors).map(x => +x))+1] = create_editor(id = Math.max(...Object.keys(editors).map(x => +x))+1, name = 'untitled.ml', theme= editors[Math.min(...Object.keys(editors).map(x => +x))].getOption('theme'));"><i
                        class="material-icons">add</i></a></li>
            <li><a onclick="exec_all(editors[actual_editor()])"><i class="material-icons">play_arrow</i></a></li>
            <li><a onclick="save(editors[actual_editor()]);"><i class="material-icons">save</i></a></li>
            <li>
                <a>
                    <label for="file-upload" class="custom-file-upload">
                        <i class="material-icons">folder</i> <input id="file-upload" type="file"
                                                                    style="display: none;"/>
                    </label>
                </a>
            </li>
            <li><a class="modal-trigger" href="#help"><i class="material-icons">settings</i></a></li>
        </ul>
    </div>
    <div  class="nav-content">
        <ul id="editor-files" class="tabs">
        </ul>
    </div>
</nav>

<div class="fixedab hide-on-small-and-down" style="bottom: 15px; left: 15px;">
    <a class="btn-floating btn-small waves-effect waves-light zoom-button" onclick="changefontsize('box_1', 1.1)"><i
            class="material-icons">add</i></a>
    <a class="btn-floating btn-small waves-effect waves-light zoom-button" onclick="changefontsize('box_1', 0.9)"><i
            class="material-icons">remove</i></a>
</div>

<div class="fixed-action-btn hide-on-small-and-down" style="bottom: 15px; right: 15px;">
    <a class="btn-floating btn-small waves-effect waves-light zoom-button" onclick="document.getElementById('output').innerHTML=''"><i
            class="material-icons">delete</i></a>
    <a class="btn-floating btn-small waves-effect waves-light zoom-button" onclick="changefontsize('box_2', 1.1)"><i
            class="material-icons">add</i></a>
    <a class="btn-floating btn-small waves-effect waves-light zoom-button" onclick="changefontsize('box_2', 0.9)"><i
            class="material-icons">remove</i></a>
</div>

<div class="fixed-action-btn mobile-button hide-on-med-and-up" style="bottom: 15px; right: 15px;">
    <a class="btn-floating btn-small waves-effect waves-light zoom-button" onclick="exec_all(editors[actual_editor()])"><i
            class="material-icons">play_arrow</i></a>
    <a class="btn-floating btn-small waves-effect waves-light zoom-button" onclick="document.getElementById('output').innerHTML=''"><i
            class="material-icons">delete</i></a>
</div>

<div id="help" class="modal help">
    <div class="modal-content">

        <h4>Themes</h4>
        <select name="theme" id="theme-select">
            <option value="material">Default</option>
            <option value="monokai">Monokai</option>
            <option value="mdn-like">MDN</option>
        </select>

        <div class="switch hide-on-small-and-down">
            <label>
                Row style
                <input type="checkbox" onclick="switch_rc_style(resize_bar);">
                <span class="lever"></span>
                Column Style
            </label>
        </div>

        <p>
            <label>
                <input type="checkbox" checked="checked" onclick="
                    config_hard_autocomplete=!config_hard_autocomplete;
                    localStorage.setItem('betterocaml-autocomplete', config_hard_autocomplete);
                "/>
                <span>Autocomplete</span>
            </label>
        </p>

        <a class="waves-effect waves-light btn" onclick="reset_ocaml();"><i class="material-icons right">refresh</i>Reset Ocaml Interpreter</a>

        <h4>Aides</h4>

        <blockquote class="commands">
            <b>Ctrl + Enter / Cmd + Enter</b> : Execute le bloc code surlign√©
        </blockquote>
        <blockquote class="commands">
            <b>Ctrl + Shift + Enter / Cmd + Shift + Enter</b> : Execute tout le code
        </blockquote>
        <a class="github-button" href="https://github.com/jbdo99/betterocaml" data-size="large"
           aria-label="Issue jbdo99/betterocaml on GitHub">Open in Github</a>
        <a class="github-button" href="https://github.com/jbdo99/betterocaml/issues" data-icon="octicon-issue-opened"
           data-size="large" aria-label="Issue jbdo99/betterocaml on GitHub">Issue</a>

    </div>
    <div class="modal-footer help">
        <a href="#" class="modal-close waves-effect waves-green btn-flat white-text">Fermer</a>
    </div>
</div>

<div id="saveas" class="modal help">
    <div class="modal-content">
        <h4>Enregistrer sous ...</h4>
        <div class="input-field col s6">
            <input placeholder="untitled.ml" id="saveas_text" type="text" class="white-text">
        </div>
    </div>
    <div class="modal-footer help">
        <button class="btn modal-close waves-effect waves-light zoom-button right"
                onclick="name_and_save(editors[actual_editor()]);">
            Enregistrer
            <i class="material-icons right">save</i>
        </button>
    </div>
</div>


<div class="container-boc container horizontal">
    <div id="box_1" class="box editor-box" style="display:flex;flex-direction:column">


        <div class="editorCollection" id="editorCollection">
        </div>
    </div>

    <div name="resizerH1"></div>

    <div id="box_2" class="box console-box">
        <div id="toplevel-container" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
            <pre id="output"></pre>
            <div>
                <div id="sharp" class="sharp"></div>
                <textarea id="userinput">Loading ...</textarea>
            </div>
        </div>
    </div>

</div>
<script type="text/javascript" src="js/jquery.min.js"></script>
<script src="js/materialize.min.js"></script>
<script src="js/editor_change.js"></script>
<script type="text/javascript">
    // Editors
    var config_hard_autocomplete;
    let editors = {}
    editors[0] = create_editor(id = 0, name = 'untitled.ml');

    // Loading function
    window.addEventListener("load", function () {
        // Crete the resize bar
        resize_bar = new Resizer(document.querySelector('[name=resizerH1]'), 'H');
        if (window.innerWidth <= 600){
            change_resize_bar(resize_bar, "V")
        }
        else{
            change_resize_bar(resize_bar, "H")
        }
        // Set text zoom
        document.getElementById('box_1').style.fontSize = "1.2em";
        document.getElementById('box_2').style.fontSize = "1.2em";

        //Load stored config
        if (localStorage.getItem('betterocaml-theme') != null){
            change_theme(localStorage.getItem('betterocaml-theme'), editors);
        }
        else {
            localStorage.setItem('betterocaml-theme', 'material');
            change_theme("material", editors);
        }
        if (localStorage.getItem('betterocaml-autocomplete') != null){
            config_hard_autocomplete = Boolean(localStorage.getItem('betterocaml-autocomplete'));
        }
        else {
            localStorage.setItem('betterocaml-autocomplete', true);
            config_hard_autocomplete = Boolean(localStorage.getItem('betterocaml-autocomplete'))
        }

        // Service Worker
        if('serviceWorker' in navigator){
            try {
                navigator.serviceWorker.register('serviceWorker.js');
                console.log("Service Worker Registered");
            } catch (error) {
                console.log("Service Worker Registration Failed");
            }
        }
    }, false);

    // Loading Animation
    $('body').on('DOMNodeInserted', 'pre', function () {
        $('#loader-wrapper').addClass("tester")
    });
    document.getElementById("loader-wrapper").addEventListener("animationend", (ev) => {
        if (ev.type === "animationend") {
            document.getElementById("loader-wrapper").style.display = "none";
            $('body').off('DOMNodeInserted');
        }
    }, false);

    // Prevent exiting without saving
    window.onbeforeunload = function () {
        if (Object.keys(editors).length > 1) {
            if (! editors[id].is_saved){
                return "Your code is not saved, do you really want to leave ?"
            }
        }
    };

    // Change disposition when small screen (need rework)
    window.onresize = function () {
        if (window.innerWidth <= 600){
            change_resize_bar(resize_bar, "V")
        }
        else{
            change_resize_bar(resize_bar, "H")
        }
    };

    // Load Materialize Components
    $(document).ready(function () {
        $('.modal').modal();
        $('.tabs').tabs();
        $('.sidenav').sidenav();
    });

    // Open file
    document.getElementById('file-upload')
        .addEventListener('change', readSingleFile, false);

    // Change theme
    document.getElementById('theme-select')
        .addEventListener('change',
            function (e) {
                change_theme(e.target.value, editors);
            }, false);

    // Autotarget the console
    document.getElementById("toplevel-container").addEventListener("click", (event) => {
        if (event.target == event.currentTarget) document.getElementById('userinput').focus();
    });

</script>


</body>
</html>
